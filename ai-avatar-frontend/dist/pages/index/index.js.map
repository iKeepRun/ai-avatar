{"version":3,"file":"pages/index/index.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC1PA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://ai-avatar-frontend/./src/pages/index/index.tsx?acc1","webpack://ai-avatar-frontend/._src_pages_index_index.tsx"],"sourcesContent":["import _regeneratorRuntime from \"D:/_code/ai-avatar/ai-avatar-frontend/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _typeof from \"D:/_code/ai-avatar/ai-avatar-frontend/node_modules/@babel/runtime/helpers/esm/typeof.js\";\nimport _asyncToGenerator from \"D:/_code/ai-avatar/ai-avatar-frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _slicedToArray from \"D:/_code/ai-avatar/ai-avatar-frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport { View, Image, Button } from '@tarojs/components';\nimport Taro, { useLoad } from '@tarojs/taro';\nimport { useState } from 'react';\nimport { uploadImage } from '../../services/api';\nimport './index.scss';\n\n// 导入图片\nimport logo from '@/assets/images/logo.png';\nimport upload from '@/assets/images/upload.png';\nimport { useStore } from '@/stores';\nimport { jsx as _jsx, jsxs as _jsxs } from \"react/jsx-runtime\";\nexport default function Index() {\n  var _useState = useState(''),\n    _useState2 = _slicedToArray(_useState, 2),\n    imageUrl = _useState2[0],\n    setImageUrl = _useState2[1];\n  var _useState3 = useState(false),\n    _useState4 = _slicedToArray(_useState3, 2),\n    loading = _useState4[0],\n    setLoading = _useState4[1];\n  var _useState5 = useState(''),\n    _useState6 = _slicedToArray(_useState5, 2),\n    error = _useState6[0],\n    setError = _useState6[1];\n  var _useStore = useStore(),\n    avatarStore = _useStore.avatarStore;\n  useLoad(function () {\n    // 检查登录状态\n    var token = Taro.getStorageSync('token');\n    if (!token) {\n      Taro.navigateTo({\n        url: '/pages/login/index'\n      });\n      return;\n    }\n  });\n  var handleChooseImage = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n      var privacyAgreed, res, errMsg;\n      return _regeneratorRuntime().wrap(function _callee$(_context) {\n        while (1) switch (_context.prev = _context.next) {\n          case 0:\n            _context.prev = 0;\n            // 先检查隐私协议\n            privacyAgreed = Taro.getStorageSync('privacyAgreed');\n            console.log('隐私协议状态:', privacyAgreed);\n            if (privacyAgreed) {\n              _context.next = 6;\n              break;\n            }\n            setError('请先同意隐私协议');\n            return _context.abrupt(\"return\");\n          case 6:\n            console.log('开始选择图片...');\n\n            // 选择图片\n            _context.next = 9;\n            return Taro.chooseImage({\n              count: 1,\n              sourceType: ['album', 'camera'],\n              // 先只提供相册选项\n              sizeType: ['compressed']\n            });\n          case 9:\n            res = _context.sent;\n            console.log('选择图片结果:', {\n              tempFilePaths: res.tempFilePaths,\n              errMsg: res.errMsg\n            });\n            if (res.tempFilePaths && res.tempFilePaths[0]) {\n              console.log('设置图片路径:', res.tempFilePaths[0]);\n              setImageUrl(res.tempFilePaths[0]);\n              setError('');\n            } else {\n              console.error('未获取到图片路径');\n              setError('未获取到图片，请重试');\n            }\n            _context.next = 20;\n            break;\n          case 14:\n            _context.prev = 14;\n            _context.t0 = _context[\"catch\"](0);\n            console.error('选择图片失败:', {\n              error: _context.t0,\n              errMsg: _context.t0.errMsg,\n              type: _typeof(_context.t0),\n              stack: _context.t0.stack\n            });\n            errMsg = _context.t0.errMsg || '';\n            console.log('错误信息:', errMsg);\n            if (errMsg.includes('authorize')) {\n              // 用户拒绝授权\n              Taro.showModal({\n                title: '提示',\n                content: '需要允许访问相册才能选择图片',\n                confirmText: '去设置',\n                success: function success(res) {\n                  if (res.confirm) {\n                    Taro.openSetting();\n                  }\n                }\n              });\n            } else if (errMsg.includes('cancel')) {\n              // 用户取消选择\n              setError('已取消选择图片');\n            } else {\n              // 尝试获取更多错误信息\n              Taro.getSetting({\n                success: function success(res) {\n                  console.log('当前权限设置:', res.authSetting);\n                },\n                fail: function fail(err) {\n                  console.error('获取权限设置失败:', err);\n                }\n              });\n              setError(\"\\u9009\\u62E9\\u56FE\\u7247\\u5931\\u8D25: \".concat(errMsg));\n            }\n          case 20:\n          case \"end\":\n            return _context.stop();\n        }\n      }, _callee, null, [[0, 14]]);\n    }));\n    return function handleChooseImage() {\n      return _ref.apply(this, arguments);\n    };\n  }();\n  var handleNext = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n      var token, uploadRes, result;\n      return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n        while (1) switch (_context2.prev = _context2.next) {\n          case 0:\n            if (imageUrl) {\n              _context2.next = 3;\n              break;\n            }\n            setError('请先选择图片');\n            return _context2.abrupt(\"return\");\n          case 3:\n            token = Taro.getStorageSync('token');\n            console.log(\"从本地缓存中获取token\", token);\n            if (token) {\n              _context2.next = 8;\n              break;\n            }\n            Taro.navigateTo({\n              url: '/pages/login/index'\n            });\n            return _context2.abrupt(\"return\");\n          case 8:\n            setLoading(true);\n            setError('');\n            _context2.prev = 10;\n            _context2.next = 13;\n            return uploadImage(imageUrl);\n          case 13:\n            uploadRes = _context2.sent;\n            result = JSON.parse(uploadRes.data); //设置 头像store 的 taskId\n            // avatarStore.setTaskId(result.data)\n            //设置 头像store 的 originalImage\n            avatarStore.setOriginalImage(imageUrl);\n            avatarStore.setCosImageUrl(result.data);\n\n            // 跳转到风格选择页面\n            Taro.navigateTo({\n              url: \"/pages/style/index\"\n            });\n            _context2.next = 24;\n            break;\n          case 20:\n            _context2.prev = 20;\n            _context2.t0 = _context2[\"catch\"](10);\n            console.error('上传失败:', _context2.t0);\n            setError('上传失败，请重试');\n          case 24:\n            _context2.prev = 24;\n            setLoading(false);\n            return _context2.finish(24);\n          case 27:\n          case \"end\":\n            return _context2.stop();\n        }\n      }, _callee2, null, [[10, 20, 24, 27]]);\n    }));\n    return function handleNext() {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n  return /*#__PURE__*/_jsxs(View, {\n    className: \"index-page\",\n    children: [/*#__PURE__*/_jsxs(View, {\n      className: \"header\",\n      children: [/*#__PURE__*/_jsx(Image, {\n        className: \"logo\",\n        src: logo\n      }), /*#__PURE__*/_jsx(View, {\n        className: \"title\",\n        children: \"AI\\u5934\\u50CF\\u751F\\u6210\\u5668\"\n      })]\n    }), /*#__PURE__*/_jsxs(View, {\n      className: \"content\",\n      children: [/*#__PURE__*/_jsx(View, {\n        className: \"upload-section\",\n        children: imageUrl ? /*#__PURE__*/_jsx(Image, {\n          className: \"preview-image\",\n          src: imageUrl,\n          mode: \"aspectFit\"\n        }) : /*#__PURE__*/_jsxs(View, {\n          className: \"upload-placeholder\",\n          onClick: handleChooseImage,\n          children: [/*#__PURE__*/_jsx(Image, {\n            className: \"upload-icon\",\n            src: upload\n          }), /*#__PURE__*/_jsx(View, {\n            className: \"upload-text\",\n            children: \"\\u70B9\\u51FB\\u4E0A\\u4F20\\u7167\\u7247\"\n          })]\n        })\n      }), error && /*#__PURE__*/_jsx(View, {\n        className: \"error-message\",\n        children: error\n      }), /*#__PURE__*/_jsx(Button, {\n        className: \"next-button\",\n        loading: loading,\n        disabled: !imageUrl || loading,\n        onClick: handleNext,\n        children: \"\\u4E0B\\u4E00\\u6B65\"\n      })]\n    }), /*#__PURE__*/_jsx(View, {\n      className: \"footer\",\n      children: /*#__PURE__*/_jsxs(View, {\n        className: \"tips\",\n        children: [/*#__PURE__*/_jsx(View, {\n          className: \"tip-item\",\n          children: \"\\u7167\\u7247\\u5927\\u5C0F\\u4E0D\\u8D85\\u8FC75MB\"\n        }), /*#__PURE__*/_jsx(View, {\n          className: \"tip-item\",\n          children: \"\\u652F\\u6301jpg\\u3001png\\u683C\\u5F0F\"\n        }), /*#__PURE__*/_jsx(View, {\n          className: \"tip-item\",\n          children: \"\\u5EFA\\u8BAE\\u4E0A\\u4F20\\u6E05\\u6670\\u7684\\u6B63\\u9762\\u7167\\u7247\"\n        })]\n      })\n    })]\n  });\n}","import { createPageConfig } from '@tarojs/runtime'\nimport component from \"!!../../../node_modules/@tarojs/taro-loader/lib/entry-cache.js?name=pages/index/index!./index.tsx\"\nvar config = {};\n\n\nvar inst = Page(createPageConfig(component, 'pages/index/index', {root:{cn:[]}}, config || {}))\n\n\nexport default component\n"],"names":[],"sourceRoot":""}