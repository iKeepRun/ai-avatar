{"version":3,"file":"pages/login/index.js","mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;AChRA;AACA;AACA;AACA;AACA;AAAA;AAGA;AACA;;AAGA;;AASA;AACA;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAAA;;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAIA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AA/BA;AAAA;AAAA;AAiCA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAAA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AACA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAEA;AACA;AAAA;AAKA;AACA;AAAA;AAKA;AACA;AAAA;AAIA;AACA;AAAA;AAKA;AACA;AAAA;AAOA;AACA;AAAA;AAEA;AAAA;AACA;AAEA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AAEA;AACA;AACA;AAAA;AAGA;AAAA;AAEA;AAAA;AAAA;AAEA;AAGA;AAAA;;;;;;;;;;;;AC/KA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://ai-avatar-frontend/./src/pages/login/index.tsx?84ae","webpack://ai-avatar-frontend/._src_components_PrivacyPopup_index.tsx","webpack://ai-avatar-frontend/._src_pages_login_index.tsx"],"sourcesContent":["import _regeneratorRuntime from \"D:/_code/ai-avatar/ai-avatar-frontend/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"D:/_code/ai-avatar/ai-avatar-frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _slicedToArray from \"D:/_code/ai-avatar/ai-avatar-frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport { View, Image, Button } from '@tarojs/components';\nimport Taro from '@tarojs/taro';\nimport { useState, useEffect } from 'react';\nimport { userApi } from '../../services/api';\nimport './index.scss';\nimport PrivacyPopup from '@/components/PrivacyPopup';\nimport { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from \"react/jsx-runtime\";\nexport default function Login() {\n  var _useState = useState(false),\n    _useState2 = _slicedToArray(_useState, 2),\n    loading = _useState2[0],\n    setLoading = _useState2[1];\n  var _useState3 = useState(new Set()),\n    _useState4 = _slicedToArray(_useState3, 2),\n    privacyResolves = _useState4[0],\n    setPrivacyResolves = _useState4[1];\n  // 隐私弹窗显示控制\n  var _useState5 = useState(false),\n    _useState6 = _slicedToArray(_useState5, 2),\n    privacyVisible = _useState6[0],\n    setPrivacyVisible = _useState6[1];\n  // 添加一个标志表示用户是否同意了隐私授权\n  var _useState7 = useState(false),\n    _useState8 = _slicedToArray(_useState7, 2),\n    privacyAgreed = _useState8[0],\n    setPrivacyAgreed = _useState8[1];\n\n  // 初始化隐私监听（兼容旧版Taro）\n  useEffect(function () {\n    Taro.onNeedPrivacyAuthorization(function (resolve) {\n      privacyResolves.add(resolve);\n      setPrivacyVisible(true);\n    });\n  }, []);\n\n  // 处理隐私授权同意\n  var handlePrivacyAgree = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n      return _regeneratorRuntime().wrap(function _callee$(_context) {\n        while (1) switch (_context.prev = _context.next) {\n          case 0:\n            console.log('用户同意隐私授权');\n            _context.prev = 1;\n            setLoading(true);\n\n            // 调用微信的隐私授权API\n            _context.next = 5;\n            return Taro.requirePrivacyAuthorize();\n          case 5:\n            // 更新UI状态\n            setPrivacyVisible(false);\n            setPrivacyAgreed(true);\n\n            // 保存隐私授权状态\n            Taro.setStorageSync('privacyAgreed', true);\n            _context.next = 15;\n            break;\n          case 10:\n            _context.prev = 10;\n            _context.t0 = _context[\"catch\"](1);\n            console.error('隐私授权失败:', _context.t0);\n            Taro.showToast({\n              title: '隐私授权失败，请重试',\n              icon: 'none'\n            });\n            // 重置状态\n            setPrivacyAgreed(false);\n          case 15:\n            _context.prev = 15;\n            setLoading(false);\n            return _context.finish(15);\n          case 18:\n          case \"end\":\n            return _context.stop();\n        }\n      }, _callee, null, [[1, 10, 15, 18]]);\n    }));\n    return function handlePrivacyAgree() {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  // 处理获取用户信息和登录\n  var handleGetUserInfo = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(e) {\n      var _yield$Taro$login, code, res;\n      return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n        while (1) switch (_context2.prev = _context2.next) {\n          case 0:\n            console.log('获取用户信息', e);\n            if (privacyAgreed) {\n              _context2.next = 5;\n              break;\n            }\n            Taro.showToast({\n              title: '请先同意隐私授权',\n              icon: 'none'\n            });\n            console.log('return return 1');\n            return _context2.abrupt(\"return\");\n          case 5:\n            if (!(!e || !e.detail || !e.detail.userInfo)) {\n              _context2.next = 10;\n              break;\n            }\n            console.log('用户拒绝授权获取用户信息');\n            Taro.showToast({\n              title: '需要授权获取用户信息才能继续',\n              icon: 'none'\n            });\n            console.log('return return2 ');\n            return _context2.abrupt(\"return\");\n          case 10:\n            _context2.prev = 10;\n            setLoading(true);\n            // 保存用户信息\n            Taro.setStorageSync('userInfo', e.detail.userInfo);\n\n            // 获取微信登录code\n            _context2.next = 15;\n            return Taro.login();\n          case 15:\n            _yield$Taro$login = _context2.sent;\n            code = _yield$Taro$login.code;\n            console.log('code', code);\n            if (code) {\n              _context2.next = 20;\n              break;\n            }\n            throw new Error('获取登录code失败');\n          case 20:\n            _context2.next = 22;\n            return userApi.login({\n              code: code,\n              avatarUrl: e.detail.userInfo.avatarUrl,\n              nickName: e.detail.userInfo.nickName\n            });\n          case 22:\n            res = _context2.sent;\n            if (!(res.data.code !== 200)) {\n              _context2.next = 25;\n              break;\n            }\n            throw new Error(res.data.msg || '登录失败');\n          case 25:\n            // 保存token\n            Taro.setStorageSync('token', res.data.data);\n\n            // 返回首页\n            Taro.switchTab({\n              url: '/pages/index/index'\n            });\n            _context2.next = 33;\n            break;\n          case 29:\n            _context2.prev = 29;\n            _context2.t0 = _context2[\"catch\"](10);\n            console.error('登录流程失败:', _context2.t0);\n            Taro.showToast({\n              title: _context2.t0.message || '登录失败，请重试',\n              icon: 'none'\n            });\n          case 33:\n            _context2.prev = 33;\n            setLoading(false);\n            return _context2.finish(33);\n          case 36:\n          case \"end\":\n            return _context2.stop();\n        }\n      }, _callee2, null, [[10, 29, 33, 36]]);\n    }));\n    return function handleGetUserInfo(_x) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n  var handleLogin = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3() {\n      return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n        while (1) switch (_context3.prev = _context3.next) {\n          case 0:\n            if (!loading) {\n              _context3.next = 2;\n              break;\n            }\n            return _context3.abrupt(\"return\");\n          case 2:\n            if (!privacyAgreed) {\n              _context3.next = 4;\n              break;\n            }\n            return _context3.abrupt(\"return\");\n          case 4:\n            try {\n              setLoading(true);\n              // 显示隐私弹窗\n              setPrivacyVisible(true);\n              setPrivacyAgreed(false);\n            } catch (err) {\n              console.error('显示隐私弹窗失败:', err);\n              Taro.showToast({\n                title: '系统错误，请重试',\n                icon: 'none'\n              });\n            } finally {\n              setLoading(false);\n            }\n          case 5:\n          case \"end\":\n            return _context3.stop();\n        }\n      }, _callee3);\n    }));\n    return function handleLogin() {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n  var handleDisagree = function handleDisagree() {\n    setPrivacyVisible(false);\n    setPrivacyAgreed(false);\n    Taro.showToast({\n      title: '需要同意隐私授权才能继续',\n      icon: 'none'\n    });\n  };\n  return /*#__PURE__*/_jsxs(_Fragment, {\n    children: [/*#__PURE__*/_jsx(PrivacyPopup, {\n      visible: privacyVisible,\n      onAgree: handlePrivacyAgree,\n      onDisagree: handleDisagree\n    }), /*#__PURE__*/_jsxs(View, {\n      className: \"login-page\",\n      children: [/*#__PURE__*/_jsxs(View, {\n        className: \"header\",\n        children: [/*#__PURE__*/_jsx(Image, {\n          className: \"logo\",\n          src: \"../../assets/images/logo.png\"\n        }), /*#__PURE__*/_jsx(View, {\n          className: \"title\",\n          children: \"AI\\u5934\\u50CF\\u751F\\u6210\\u5668\"\n        }), /*#__PURE__*/_jsx(View, {\n          className: \"subtitle\",\n          children: \"\\u4E00\\u952E\\u751F\\u6210\\u4F60\\u7684\\u4E13\\u5C5E\\u5934\\u50CF\"\n        })]\n      }), /*#__PURE__*/_jsx(View, {\n        className: \"content\",\n        children: /*#__PURE__*/_jsx(Button, {\n          className: \"login-button\",\n          loading: loading,\n          onClick: handleLogin,\n          openType: \"getUserInfo\",\n          onGetUserInfo: handleGetUserInfo,\n          children: \"\\u5FAE\\u4FE1\\u4E00\\u952E\\u767B\\u5F55\"\n        })\n      }), /*#__PURE__*/_jsx(View, {\n        className: \"footer\",\n        children: /*#__PURE__*/_jsxs(View, {\n          className: \"tips\",\n          children: [/*#__PURE__*/_jsx(View, {\n            className: \"tip-item\",\n            children: \"\\u767B\\u5F55\\u540E\\u5373\\u53EF\\u4F7F\\u7528\\u5B8C\\u6574\\u529F\\u80FD\"\n          }), /*#__PURE__*/_jsx(View, {\n            className: \"tip-item\",\n            children: \"\\u6211\\u4EEC\\u627F\\u8BFA\\u4FDD\\u62A4\\u60A8\\u7684\\u9690\\u79C1\\u5B89\\u5168\"\n          })]\n        })\n      })]\n    })]\n  });\n}","import  {  useEffect, useState} from 'react';\nimport { View, Text, Button } from '@tarojs/components';\nimport './index.scss';\nimport { useDidShow } from '@tarojs/taro';\nimport Taro from '@tarojs/taro'\n\n\nlet privacyHandler;\nlet privacyResolves = new Set<Function>();\n\n\n// PrivacyPopup.tsx\ninterface Props {\n    visible: boolean;\n    onAgree?: () => void;\n    onDisagree?: () => void;\n  }\n  \n  \n\nif (Taro?.onNeedPrivacyAuthorization) {\n  Taro?.onNeedPrivacyAuthorization(resolve => {\n    privacyHandler?.(resolve);\n  });\n}\n\nexport default function PrivacyPopup (props:Props) {\n    console.log(\"ppppppp\",props)\n  const [visible, setVisible] = useState<boolean>(props.visible);\n\n  // 当props.visible变化时更新本地状态\n  useEffect(() => {\n    setVisible(props.visible);\n  }, [props.visible]);\n\n  const handleDisagree = () => {\n    setVisible(false);\n    privacyResolves.forEach(resolve => {\n      resolve({\n        event: 'disagree'\n      });\n    });\n    privacyResolves.clear();\n    // 调用父组件的onDisagree回调\n    if (props.onDisagree) {\n      props.onDisagree();\n    }\n  };\n\n  const handleAgree = async () => {\n    console.log('PrivacyPopup: 用户点击同意按钮');\n    \n    try {\n      // 先调用微信的隐私授权API\n      await Taro.requirePrivacyAuthorize();\n      \n      // 处理所有等待中的隐私授权请求\n      privacyResolves.forEach(resolve => {\n        resolve({\n          event: 'agree',\n          buttonId: 'agree-btn'\n        });\n      });\n      privacyResolves.clear();\n      \n      // 更新UI状态\n      setVisible(false);\n      \n      // 调用父组件的onAgree回调\n      if (props.onAgree) {\n        console.log('PrivacyPopup: 调用父组件的onAgree回调');\n        props.onAgree();\n      }\n    } catch (err) {\n      console.error('隐私授权失败:', err);\n      Taro.showToast({\n        title: '隐私授权失败，请重试',\n        icon: 'none'\n      });\n    }\n  };\n\n  useEffect(() => {\n    privacyHandler = resolve => {\n      privacyResolves.add(resolve);\n      setVisible(true);\n    };\n  }, []);\n  \n  // useDidShow还需要调用的原因：比如当前页面需要隐私弹窗，但未触发弹出，允许用户点有些按钮跳转去其他需要隐私弹窗的页面。用户再回退当前页面，此时privacyHandler要重新设置成当前页面的弹窗\n  useDidShow(() => {\n    privacyHandler = resolve => {\n      privacyResolves.add(resolve);\n      setVisible(true);\n    };\n  });\n\n  const openPrivacyContract = () => {\n    Taro?.openPrivacyContract({\n      success: () => {\n        console.log('openPrivacyContract success');\n      },\n      fail: res => {\n        console.error('openPrivacyContract fail', res);\n      }\n    });\n  };\n\n  return (\n    <View className=\"pp-container\">\n      {visible && <View className=\"pp-mask\" />}\n      {visible && (\n        <View className=\"pp-wrap\">\n          <View className=\"pp-head\">\n            <View className=\"pp-head-title\">用户隐私保护提示</View>\n          </View>\n          <View className=\"pp-content\">\n            <View className='privacy-content'>\n              <View className='privacy-title'>隐私保护指引</View>\n              <View className='privacy-text'>\n                感谢您使用我们的服务。为了更好地保护您的个人信息，请您仔细阅读以下内容：\n              </View>\n              <View className='privacy-text'>\n                1. 我们可能会收集您的以下信息：\n                - 微信头像和昵称\n                - 相册中的图片（用于头像生成）\n                - 设备信息\n              </View>\n              <View className='privacy-text'>\n                2. 我们承诺：\n                - 仅将您的信息用于提供服务\n                - 不会将您的信息用于其他用途\n                - 采取严格的安全措施保护您的信息\n              </View>\n              <View className='privacy-text'>\n                3. 您需要授权：\n                - 获取用户信息（头像、昵称）\n                - 访问相册（用于选择头像图片）\n              </View>\n              <View className='privacy-text'>\n                4. 权限说明：\n                - 相册权限：用于选择头像图片\n                - 相机权限：用于拍摄头像图片\n                - 存储权限：用于保存生成的头像\n              </View>\n              <View className='privacy-text'>\n                5. 隐私协议：\n                我们严格遵守微信小程序的隐私协议要求，包括但不限于：\n                - 明确告知用户收集的信息类型和用途\n                - 获取用户明确授权\n                - 保护用户数据安全\n                - 遵守相关法律法规\n              </View>\n              <View className='privacy-text'>\n                如您同意以上内容，请点击\"同意\"继续使用我们的服务。\n              </View>\n            </View>\n          </View>\n          <View className=\"pp-footer\">\n            <Button id=\"disagree-btn\" className=\"pp-btn pp-btn_refuse\" onClick={handleDisagree}>\n              拒绝\n            </Button>\n            <Button\n              id=\"agree-btn\"\n              className=\"pp-btn\"\n              onClick={handleAgree}\n            >\n              同意\n            </Button>\n          </View>\n          <View className=\"pp-safearea\" />\n        </View>\n      )}\n    </View>\n  );\n};\n\n\n","import { createPageConfig } from '@tarojs/runtime'\nimport component from \"!!../../../node_modules/@tarojs/taro-loader/lib/entry-cache.js?name=pages/login/index!./index.tsx\"\nvar config = {};\n\n\nvar inst = Page(createPageConfig(component, 'pages/login/index', {root:{cn:[]}}, config || {}))\n\n\nexport default component\n"],"names":[],"sourceRoot":""}